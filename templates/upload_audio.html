<!DOCTYPE html>
<html>
  <head>
    <title>File Upload</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#fileInput").hide();
        $("#uploadForm").prepend(
          '<button id="uploadAudio">Upload Audio</button>'
        );

        $("#uploadAudio").click(function () {
          $("#fileInput").click();
        });

        $("#fileInput").change(function () {
          if ($(this).val()) {
            $.ajax({
              url: "/clear_uploads",
              type: "GET",
              success: function (response) {
                $("#uploadMessage").text("Uploading...");
                $("#uploadForm").submit();
                updateFileList();
              },
              error: function () {
                $("#uploadMessage").text("Failed to clear uploads directory");
              },
            });
          }
        });

        $("#uploadForm").on("submit", function (e) {
          e.preventDefault();
          var files = $("#fileInput")[0].files;
          if (files.length === 0) {
            $("#uploadMessage").text("No file selected");
            return false;
          }

          $.ajax({
            url: "/",
            type: "POST",
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function (response) {
              $("#uploadMessage").text("File uploaded successfully");
              $("#processFiles").prop("disabled", false);
            },
            error: function () {
              $("#uploadMessage").text("Upload failed");
            },
          });
        });

        $("#processFiles").on("click", function () {
          $("#processFiles").prop("disabled", true);
          $("#uploadAudio").prop("disabled", true); // Disable the Upload Audio button
          $("#uploadMessage").text("Processing files...");
          $.ajax({
            url: "/process",
            type: "GET",
            success: function (response) {
              $("#uploadMessage").text(
                "Processing completed. Downloading files..."
              );
              window.location.href = "/download";
              $("#uploadAudio").prop("disabled", false); // Re-enable the Upload Audio button
            },
            error: function () {
              $("#uploadMessage").text("Processing failed");
              $("#uploadAudio").prop("disabled", false); // Re-enable the button in case of error
            },
          });
        });

        // Function to check processing status and enable the Upload Audio button if processing is complete
        function checkProcessingStatus() {
          $.ajax({
            url: "/check_processing",
            type: "GET",
            success: function (response) {
              if (response.processingComplete) {
                $("#uploadAudio").prop("disabled", false); // Enable the Upload Audio button
              } else {
                setTimeout(checkProcessingStatus, 3000); // Check again after 3 seconds
              }
            },
            error: function () {
              $("#uploadMessage").text("Failed to check processing status");
            },
          });
        }

        // Call the function to check processing status after the page loads
        $(document).ready(function () {
          checkProcessingStatus();
        });

        function updateFileList() {
          var files = $("#fileInput")[0].files;
          var fileList = $("#fileList");
          fileList.empty();
          $.each(files, function (index, file) {
            fileList.append("<li>" + file.name + "</li>");
          });
        }
      });
    </script>
  </head>
  <body>
    <h2>Upload Call Recording</h2>
    <form id="uploadForm" method="post" enctype="multipart/form-data">
      <input type="file" id="fileInput" name="files" multiple />
      <span id="uploadMessage"></span>
    </form>
    <div>
      <h3>Recoedings to be processed:</h3>
      <ul id="fileList"></ul>
    </div>
    <button id="processFiles">Process Files</button>
  </body>
</html>
